{% extends "base.html" %}
{% load static %}
{% load dict_extras %}
{% load widget_tweaks %} {# Adăugăm widget_tweaks pentru a stiliza câmpurile formularului în modal #}

{% block title %}Date Extra Salvate per Serie{% endblock %}

{% block extra_css %}
<style>
    .table-admin tbody tr.selected-row td {
        background-color: #cfe2ff !important;
    }
    .bulk-actions-container {
        padding: 1rem 0;
        border-top: 1px solid #dee2e6;
        margin-top: -1px;
    }
    /* Stil pentru a face seria click-abilă */
    .serie-link {
        cursor: pointer;
        color: #0d6efd; /* Culoare de link Bootstrap */
        text-decoration: none;
    }
    .serie-link:hover {
        text-decoration: underline;
    }
    /* Stil pentru modal */
    #serieDetailsModal .modal-body .form-label {
        font-weight: 500;
        font-size: 0.9rem;
    }
    #serieDetailsModal .modal-body .form-control-sm {
        font-size: 0.9rem;
    }
    /* Stil pentru erorile din formularul modalului */
    .modal-field-error {
        font-size: 0.8rem;
        color: #dc3545; /* Roșu Bootstrap */
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>
                <i class="bi bi-tags-fill me-2"></i> Date Extra Salvate per Serie (LOT)
                 <small class="text-muted ms-2">({{ total_results }} înregistrări găsite)</small>
            </span>
            <a href="{% url 'administrare' %}?tab=seriedata" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Înapoi la Administrare
            </a>
        </div>

        <div class="card-body border-bottom">
            <div class="row g-2 align-items-center">
                <div class="col-md-6">
                    <form method="get" class="d-flex gap-2">
                        <div class="input-group">
                            <input type="text" name="q" class="form-control form-control-sm" placeholder="Serie (LOT)..." value="{{ search_query }}">
                            <input type="text" name="articol" class="form-control form-control-sm" placeholder="Articol..." value="{{ articol_query }}">
                            <button type="submit" class="btn btn-info btn-sm flex-shrink-0" title="Caută">
                                <i class="bi bi-search"></i>
                            </button>
                            {% if search_query or articol_query %}
                                <a href="{% url 'list_serie_extra_data' %}" class="btn btn-secondary btn-sm flex-shrink-0" title="Resetează căutarea">
                                    <i class="bi bi-x-lg"></i>
                                </a>
                            {% endif %}
                        </div>
                    </form>
                </div>
                <div class="col-md-6 text-md-end">
                </div>
            </div>
        </div>

        <div class="card-body p-0">
            {% if messages %}
                <div class="m-3">
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    {% endfor %}
                </div>
            {% endif %}
            {% if page_obj.object_list %}
                <form method="post" action="{% url 'bulk_delete_serie_data' %}" id="bulk-delete-form">
                    {% csrf_token %}
                    {% if search_query %}<input type="hidden" name="q" value="{{ search_query }}">{% endif %}
                    {% if articol_query %}<input type="hidden" name="articol" value="{{ articol_query }}">{% endif %}
                    {% if page_obj.number != 1 %}<input type="hidden" name="page" value="{{ page_obj.number }}">{% endif %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm table-admin mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col" style="width: 1%;">
                                        <input class="form-check-input" type="checkbox" id="select-all-checkbox" title="Selectează/Deselectează Tot">
                                    </th>
                                    <th scope="col">Serie (LOT)</th>
                                    <th scope="col">Articol</th>
                                    <th scope="col">Producător</th>
                                    <th scope="col">Țara</th>
                                    <th scope="col">Garanție</th>
                                    <th scope="col" class="text-end">Acțiuni</th> {# Mutăm coloana de acțiuni aici #}
                                </tr>
                            </thead>
                            <tbody>
                                {% for data in page_obj.object_list %}
                                    <tr id="row-{{ data.pk }}">
                                        <td>
                                            <input class="form-check-input row-checkbox" type="checkbox" name="selected_pks" value="{{ data.pk }}" aria-label="Selectează seria {{ data.serie }}">
                                        </td>
                                        <td class="fw-bold">
                                            {# MODIFICARE: Facem seria click-abilă #}
                                            <a href="#" class="serie-link" data-pk="{{ data.pk }}" data-bs-toggle="modal" data-bs-target="#serieDetailsModal">
                                                {{ data.serie }}
                                            </a>
                                        </td>
                                        <td id="articol-{{data.pk}}">{{ articole_map|get_item:data.serie|default:"-" }}</td>
                                        <td id="producator-{{data.pk}}">{{ data.producator|default:"-" }}</td>
                                        <td id="tara_productie-{{data.pk}}">{{ data.tara_productie|default:"-" }}</td>
                                        <td id="garantie-{{data.pk}}">{{ data.garantie|default:"-" }}</td>
                                        <td class="text-end">
                                            <a href="{% url 'delete_serie_extra_data' data.pk %}"
                                               class="btn btn-outline-danger btn-sm py-0 px-1"
                                               onclick="return confirm('Sigur ștergi datele pentru seria \'{{ data.serie }}\'?')"
                                               title="Șterge Individual">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="bulk-actions-container px-3 d-flex justify-content-between align-items-center">
                         <div>
                            <button type="submit" class="btn btn-danger btn-sm" id="bulk-delete-btn" disabled>
                                <i class="bi bi-trash-fill"></i> Șterge Selecția (<span id="selected-count">0</span>)
                            </button>
                         </div>
                         {% include "partials/_pagination.html" with page_obj=page_obj %}
                    </div>
                </form>
            {% else %}
                 <div class="alert alert-warning text-center m-3" role="alert">
                     {% if search_query or articol_query %}
                        Niciun rezultat găsit pentru căutarea efectuată.
                        <a href="{% url 'list_serie_extra_data' %}" class="alert-link ms-2">Resetează căutarea</a>
                     {% else %}
                         Nu există încă date extra salvate pentru nicio serie.
                     {% endif %}
                 </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal pentru Detalii și Editare Serie -->
<div class="modal fade" id="serieDetailsModal" tabindex="-1" aria-labelledby="serieDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="serieDetailsModalLabel">Detalii pentru Serie: <span id="modal-serie-name" class="fw-bold"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="serieDetailsModalBody">
        {# Aici va fi injectat formularul sau un mesaj de încărcare #}
        <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Se încarcă...</span>
            </div>
            <p class="mt-2">Se încarcă detaliile seriei...</p>
        </div>
      </div>
      <div class="modal-footer">
        <input type="hidden" id="current-editing-pk" value="">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anulează</button>
        <button type="button" class="btn btn-primary" id="saveSerieDetailsBtn">
            <i class="bi bi-save-fill"></i> Salvează Modificări
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
    const selectedCountSpan = document.getElementById('selected-count');
    const bulkDeleteForm = document.getElementById('bulk-delete-form');
    const serieDetailsModal = new bootstrap.Modal(document.getElementById('serieDetailsModal'));
    const modalSerieName = document.getElementById('modal-serie-name');
    const modalBody = document.getElementById('serieDetailsModalBody');
    const saveSerieDetailsBtn = document.getElementById('saveSerieDetailsBtn');
    const currentEditingPKInput = document.getElementById('current-editing-pk');

    function updateBulkDeleteButtonState() {
        const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
        const count = selectedCheckboxes.length;
        if (selectedCountSpan) selectedCountSpan.textContent = count;

        if (bulkDeleteBtn) {
            if (count > 0) {
                bulkDeleteBtn.disabled = false;
                bulkDeleteBtn.title = `Șterge ${count} înregistrări selectate`;
            } else {
                bulkDeleteBtn.disabled = true;
                bulkDeleteBtn.title = 'Selectează cel puțin o înregistrare pentru a șterge';
            }
        }

         if(selectAllCheckbox) {
            if (rowCheckboxes.length > 0 && count === rowCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else if (count > 0) {
                 selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            } else {
                 selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
         }
    }

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const isChecked = this.checked;
            rowCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
                const row = checkbox.closest('tr');
                if(row) row.classList.toggle('selected-row', isChecked);
            });
            updateBulkDeleteButtonState();
        });
    }

    rowCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const row = this.closest('tr');
            if(row) row.classList.toggle('selected-row', this.checked);
            updateBulkDeleteButtonState();
        });
    });

    if (bulkDeleteForm) {
        bulkDeleteForm.addEventListener('submit', function(event) {
            const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert('Vă rugăm să selectați cel puțin o înregistrare pentru a o șterge.');
                event.preventDefault();
                return false;
            }
            if (!confirm(`Sunteți sigur că doriți să ștergeți cele ${selectedCheckboxes.length} înregistrări selectate? Această acțiune este ireversibilă.`)) {
                event.preventDefault();
                return false;
            }
        });
    }
    updateBulkDeleteButtonState();

    // --- Logică pentru Modal Detalii/Editare Serie ---
    document.querySelectorAll('.serie-link').forEach(link => {
        link.addEventListener('click', function(event) {
            event.preventDefault();
            const pk = this.dataset.pk;
            const serieName = this.textContent.trim();

            if (modalSerieName) modalSerieName.textContent = serieName;
            if (currentEditingPKInput) currentEditingPKInput.value = pk;
            if (modalBody) modalBody.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Se încarcă...</span></div><p class="mt-2">Se încarcă detaliile seriei...</p></div>`;

            // Fetch data for the serie
            fetch(`/administrare/serie-data/details-ajax/${pk}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success' && data.serie_data) {
                        renderSerieFormInModal(data.serie_data, pk);
                    } else {
                        modalBody.innerHTML = `<div class="alert alert-danger">${data.message || 'Eroare la preluarea datelor.'}</div>`;
                    }
                })
                .catch(error => {
                    console.error("Error fetching serie details:", error);
                    modalBody.innerHTML = `<div class="alert alert-danger">A apărut o eroare la încărcarea detaliilor. Vă rugăm încercați din nou. (${error.message})</div>`;
                });
        });
    });

    function renderSerieFormInModal(serieData, pk) {
        // Definim câmpurile și etichetele lor
        // Cheile trebuie să corespundă cu cele din modelul SerieExtraData și SerieExtraDataForm
        const fields = [
            { name: 'nr_ambalaje', label: 'Nr. de ambalaje și tip' },
            { name: 'doc_oficial', label: 'Document oficial certificare (nr./emitent/data)' },
            { name: 'etch_oficiale', label: 'Etichete oficiale (seria și nr. de la/până la)' },
            { name: 'puritate', label: 'Puritate fizică (%)' },
            { name: 'sem_straine', label: 'Semințe străine (nr./%)' },
            { name: 'umiditate', label: 'Umiditate (%)' },
            { name: 'germinatie', label: 'Germinație totală (%)' },
            { name: 'masa_1000b', label: 'Masa a 1000 boabe (g)' },
            { name: 'stare_sanitara', label: 'Stare sanitară' },
            { name: 'cold', label: 'Cold test (%)' },
            { name: 'producator', label: 'Producător' },
            { name: 'tara_productie', label: 'Țara de producție' },
            { name: 'samanta_tratata', label: 'Sămânța tratată cu' },
            { name: 'garantie', label: 'Termen de valabilitate' },
        ];

        let formHtml = `<form id="editSerieForm" data-pk="${pk}">`;
        formHtml += `<input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">`;
        // Câmpul serie este important și trebuie trimis, chiar dacă e ascuns utilizatorului în formularul de editare
        formHtml += `<input type="hidden" name="serie" value="${serieData.serie || ''}">`;


        fields.forEach(field => {
            const value = serieData[field.name] || '';
            const errorMessages = serieData.errors && serieData.errors[field.name] ? serieData.errors[field.name].join('<br>') : '';
            formHtml += `
                <div class="mb-3">
                    <label for="modal-${field.name}" class="form-label">${field.label}</label>
                    <input type="text" class="form-control form-control-sm" id="modal-${field.name}" name="${field.name}" value="${value}">
                    ${errorMessages ? `<div class="modal-field-error mt-1">${errorMessages}</div>` : ''}
                </div>
            `;
        });
        formHtml += `</form>`;
        if (modalBody) modalBody.innerHTML = formHtml;
    }

    if (saveSerieDetailsBtn) {
        saveSerieDetailsBtn.addEventListener('click', function() {
            const pk = currentEditingPKInput ? currentEditingPKInput.value : null;
            const formElement = document.getElementById('editSerieForm');

            if (!pk || !formElement) {
                alert("Eroare: Nu s-a putut identifica înregistrarea pentru salvare.");
                return;
            }

            const formData = new FormData(formElement);
            // Afișează un indicator de încărcare pe buton
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Se salvează...';

            fetch(`/administrare/serie-data/details-ajax/${pk}/`, {
                method: 'POST',
                body: formData,
                headers: {
                    // 'X-CSRFToken' este deja în formData ca input hidden
                    'X-Requested-With': 'XMLHttpRequest' // Important pentru request.is_ajax
                }
            })
            .then(response => response.json()) // Ne așteptăm la JSON indiferent de statusul HTTP
            .then(data => {
                this.disabled = false; // Reactivează butonul
                this.innerHTML = '<i class="bi bi-save-fill"></i> Salvează Modificări';

                if (data.status === 'success') {
                    serieDetailsModal.hide();
                    alert(data.message || "Salvat cu succes!");
                    // Actualizează rândul în tabel (opțional, dar recomandat)
                    if (data.serie_data) {
                        updateTableRow(pk, data.serie_data);
                    } else {
                        // Dacă nu avem datele actualizate, facem un refresh la pagină
                        // location.reload();
                        // Sau, mai bine, preluăm din nou doar datele pentru rândul respectiv
                        // și actualizăm manual
                        const row = document.getElementById(`row-${pk}`);
                        if(row) {
                            // Aici poți face un nou fetch la /details-ajax/pk/ pentru a lua datele actualizate
                            // sau poți pur și simplu să pui un mesaj că s-a salvat și la refresh se vor vedea.
                            // Pentru simplitate, vom afișa mesajul și lăsăm refresh-ul manual.
                            console.log("Datele au fost actualizate. Reîmprospătați pagina pentru a vedea toate modificările.");
                        }
                    }
                } else {
                    // Afișează erorile de validare în formularul din modal
                    if (data.errors && modalBody) {
                        // Re-randează formularul cu erorile
                        // Este mai complex de implementat actualizarea directă a erorilor pe câmpuri
                        // Cel mai simplu este să afișăm un mesaj general sau să re-randezi formularul.
                        // Să presupunem că avem datele seriei în 'data.serie_data' chiar și la eroare (dacă view-ul le trimite)
                        // și erorile în 'data.errors'.
                         renderSerieFormInModal(data.serie_data || { serie: formData.get('serie') }, pk, data.errors); // Pasează și erorile
                        alert(data.message || "Eroare la validarea datelor.");
                    } else {
                        alert(data.message || "A apărut o eroare la salvare.");
                    }
                }
            })
            .catch(error => {
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-save-fill"></i> Salvează Modificări';
                console.error("Error saving serie details:", error);
                alert("A apărut o eroare de rețea sau server. Vă rugăm încercați din nou.");
            });
        });
    }

    function renderSerieFormInModal(serieData, pk, errors = null) { // Adăugat parametru errors
        const fields = [ /* ... la fel ca mai sus ... */
            { name: 'nr_ambalaje', label: 'Nr. de ambalaje și tip' },
            { name: 'doc_oficial', label: 'Document oficial certificare (nr./emitent/data)' },
            { name: 'etch_oficiale', label: 'Etichete oficiale (seria și nr. de la/până la)' },
            { name: 'puritate', label: 'Puritate fizică (%)' },
            { name: 'sem_straine', label: 'Semințe străine (nr./%)' },
            { name: 'umiditate', label: 'Umiditate (%)' },
            { name: 'germinatie', label: 'Germinație totală (%)' },
            { name: 'masa_1000b', label: 'Masa a 1000 boabe (g)' },
            { name: 'stare_sanitara', label: 'Stare sanitară' },
            { name: 'cold', label: 'Cold test (%)' },
            { name: 'producator', label: 'Producător' },
            { name: 'tara_productie', label: 'Țara de producție' },
            { name: 'samanta_tratata', label: 'Sămânța tratată cu' },
            { name: 'garantie', label: 'Termen de valabilitate' },
        ];
        let formHtml = `<form id="editSerieForm" data-pk="${pk}">`;
        formHtml += `<input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">`;
        formHtml += `<input type="hidden" name="serie" value="${serieData.serie || ''}">`;

        fields.forEach(field => {
            const value = serieData[field.name] || '';
            // Preluăm erorile pentru câmpul curent
            const fieldErrors = errors && errors[field.name] ? errors[field.name].join('<br>') : '';
            formHtml += `
                <div class="mb-3">
                    <label for="modal-${field.name}" class="form-label">${field.label}</label>
                    <input type="text" class="form-control form-control-sm ${fieldErrors ? 'is-invalid' : ''}" id="modal-${field.name}" name="${field.name}" value="${value}">
                    ${fieldErrors ? `<div class="invalid-feedback modal-field-error">${fieldErrors}</div>` : ''}
                </div>
            `;
        });
        formHtml += `</form>`;
        if (modalBody) modalBody.innerHTML = formHtml;
    }


    function updateTableRow(pk, serieData) {
        const row = document.getElementById(`row-${pk}`);
        if (!row) return;

        // Actualizează celulele relevante. Asigură-te că ID-urile celulelor sunt corecte.
        // Aceste ID-uri au fost adăugate în HTML-ul tabelului.
        const producatorCell = document.getElementById(`producator-${pk}`);
        const taraCell = document.getElementById(`tara_productie-${pk}`);
        const garantieCell = document.getElementById(`garantie-${pk}`);
        // Adaugă și alte celule dacă este necesar (ex: articol dacă se poate schimba și vrei să-l actualizezi)

        if (producatorCell) producatorCell.textContent = serieData.producator || '-';
        if (taraCell) taraCell.textContent = serieData.tara_productie || '-';
        if (garantieCell) garantieCell.textContent = serieData.garantie || '-';

        // Poți adăuga un highlight temporar pe rândul actualizat
        row.classList.add('table-success'); // Sau altă clasă Bootstrap
        setTimeout(() => {
            row.classList.remove('table-success');
        }, 2000); // Elimină highlight-ul după 2 secunde
    }

});
</script>
{% endblock %}