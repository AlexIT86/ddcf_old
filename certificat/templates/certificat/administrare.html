{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %} {# Asigură-te că crispy forms e configurat #}
{% block title %}Administrare{% endblock %}

{% block extra_css %}
<style>
  /* Stiluri pentru a asigura consistența vizuală */
  .admin-section .card {
    border: 1px solid #dee2e6; /* Linie subtilă */
    border-radius: 0.375rem; /* Bootstrap default */
    box-shadow: 0 1px 3px rgba(0,0,0,0.04); /* Umbră discretă */
    margin-bottom: 1.5rem;
    overflow: hidden; /* Necesare pentru carduri cu tabele fără padding */
  }
  .admin-section .card-header {
    background-color: #f8f9fa; /* Fundal header card */
    border-bottom: 1px solid #dee2e6;
    font-size: 1rem; /* Mărime font normală */
    font-weight: 500; /* Puțin mai bold */
    padding: 0.75rem 1rem; /* Padding standard */
    display: flex;
    align-items: center;
    gap: 0.5rem; /* Spațiu între iconiță și text */
  }
  .admin-section .card-body {
      padding: 1rem; /* Padding consistent */
  }
  .admin-section .card-body.p-0 .table-responsive {
       border-radius: 0 0 0.375rem 0.375rem; /* Rotunjire colțuri jos pt tabel */
       overflow: hidden;
  }

  .admin-icon {
    font-size: 1.1rem; /* Mărime iconiță */
    color: #6c757d; /* Culoare gri */
  }
  .nav-pills .nav-link {
    border-radius: 0.3rem;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem; /* Spațiu între butoane pe mobil */
    color: #495057;
    font-weight: 500;
    background-color: #e9ecef; /* Fundal butoane inactive */
    padding: 0.5rem 0.9rem; /* Padding butoane */
    display: flex; /* Aliniere iconiță */
    align-items: center;
    gap: 0.4rem;
    transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out;
  }
   .nav-pills .nav-link:hover {
       background-color: #d3d9df;
   }
  .nav-pills .nav-link.active {
    background-color: #0d6efd;
    color: white;
    box-shadow: 0 2px 5px rgba(13, 110, 253, 0.3);
  }
   .nav-pills .nav-link.active .admin-icon {
        color: white; /* Iconița devine albă pe fundal activ */
   }

  .table-admin thead {
    background-color: #f8f9fa; /* Fundal header tabel */
    color: #212529; /* Text mai închis */
    font-weight: 500;
    font-size: 0.9rem; /* Text header tabel mai mic */
  }
  .table-admin {
      margin-bottom: 0; /* Elimină marginea tabelului dacă e în card-body p-0 */
      font-size: 0.9rem; /* Text tabel mai mic */
  }
  .table-admin th, .table-admin td {
      vertical-align: middle;
      padding: 0.6rem 0.75rem; /* Padding celule */
  }
  .table-admin .btn-sm i {
      margin-right: 0; /* Eliminăm marginea iconiței din buton */
      font-size: 0.9em; /* Iconițe puțin mai mici în butoane */
  }
   .table-admin .btn-group .btn {
        padding: 0.2rem 0.4rem; /* Padding mai mic pt butoane în grup */
   }

  /* Stiluri pentru formulare crispy */
  .crispy-form-button-wrapper {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid #eee;
  }

  /* Consistență carduri stânga/dreapta */
  .form-card, .list-card {
      min-height: 400px; /* Sau altă valoare, pentru aliniere aproximativă */
      display: flex;
      flex-direction: column;
  }
   .list-card .card-body {
       flex-grow: 1; /* Permite corpului listei să se extindă */
   }

</style>
{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
  <h1 class="mb-4"><i class="bi bi-gear-wide-connected"></i> Panou Administrare</h1>

  <ul class="nav nav-pills mb-4 flex-wrap" id="adminTabs" role="tablist">
    {# Tab Utilizatori - doar pentru superadmin #}
    {% if user.userprofile and user.userprofile.role and user.userprofile.role.name|lower == 'superadmin' %}
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if not request.GET.tab or request.GET.tab == 'user' %}active{% endif %}" id="user-tab" data-bs-toggle="pill" data-bs-target="#user-pane" type="button" role="tab" aria-controls="user-pane" aria-selected="{% if not request.GET.tab or request.GET.tab == 'user' %}true{% else %}false{% endif %}">
                <i class="bi bi-people-fill admin-icon"></i>Utilizatori
            </button>
        </li>
    {% endif %}
    
    {# Tab Roluri - doar pentru superadmin #}
    {% if user.userprofile and user.userprofile.role and user.userprofile.role.name|lower == 'superadmin' %}
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if request.GET.tab == 'role' %}active{% endif %}" id="role-tab" data-bs-toggle="pill" data-bs-target="#role-pane" type="button" role="tab" aria-controls="role-pane" aria-selected="false">
                <i class="bi bi-shield-lock-fill admin-icon"></i>Roluri
            </button>
        </li>
    {% endif %}
    
    {# Tab Gestiuni - pentru cei cu ok_gestiuni #}
    {% if user.userprofile and user.userprofile.ok_gestiuni %}
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if request.GET.tab == 'gestiune' %}active{% endif %}" id="gestiune-tab" data-bs-toggle="pill" data-bs-target="#gestiune-pane" type="button" role="tab" aria-controls="gestiune-pane" aria-selected="false">
                <i class="bi bi-building admin-icon"></i>Gestiuni
            </button>
        </li>
    {% endif %}
    
    {# Tab Plaje Numere - pentru cei cu ok_plaje #}
    {% if user.userprofile and user.userprofile.ok_plaje %}
         <li class="nav-item" role="presentation">
            <button class="nav-link {% if request.GET.tab == 'documentrange' %}active{% endif %}" id="documentrange-tab" data-bs-toggle="pill" data-bs-target="#documentrange-pane" type="button" role="tab" aria-controls="documentrange-pane" aria-selected="false">
                <i class="bi bi-body-text admin-icon"></i>Plaje Numere
            </button>
        </li>
    {% endif %}
    
    {# Tab Tipologii - pentru cei cu ok_tipologii #}
    {% if user.userprofile and user.userprofile.ok_tipologii %}
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if request.GET.tab == 'tipologie' %}active{% endif %}" id="tipologie-tab" data-bs-toggle="pill" data-bs-target="#tipologie-pane" type="button" role="tab" aria-controls="tipologie-pane" aria-selected="false">
                <i class="bi bi-tags-fill admin-icon"></i>Tipologii
            </button>
        </li>
    {% endif %}
    
    {# Tab Mapare Specie - doar pentru superadmin #}
    {% if user.userprofile and user.userprofile.role and user.userprofile.role.name|lower == 'superadmin' %}
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if request.GET.tab == 'speciemapping' %}active{% endif %}" id="speciemapping-tab" data-bs-toggle="pill" data-bs-target="#speciemapping-pane" type="button" role="tab" aria-controls="speciemapping-pane" aria-selected="false">
                <i class="bi bi-link-45deg admin-icon"></i>Mapare Specie
            </button>
        </li>
    {% endif %}
    
    {# Tab Date Serie - doar pentru superadmin #}
    {% if user.userprofile and user.userprofile.role and user.userprofile.role.name|lower == 'superadmin' %}
         <li class="nav-item" role="presentation">
            <button class="nav-link {% if request.GET.tab == 'seriedata' %}active{% endif %}" id="seriedata-tab" data-bs-toggle="pill" data-bs-target="#seriedata-pane" type="button" role="tab" aria-controls="seriedata-pane" aria-selected="false">
                <i class="bi bi-journal-bookmark-fill admin-icon"></i>Date Serie (LOT)
            </button>
        </li>
    {% endif %}
    
    {# Tab Manual Utilizare - doar pentru superadmin #}
    {% if user.userprofile and user.userprofile.role and user.userprofile.role.name|lower == 'superadmin' %}
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if request.GET.tab == 'usermanual' %}active{% endif %}" id="usermanual-tab" data-bs-toggle="pill" data-bs-target="#usermanual-pane" type="button" role="tab" aria-controls="usermanual-pane" aria-selected="false">
                <i class="bi bi-book admin-icon"></i>Manual Utilizare
            </button>
        </li>
    {% endif %}
    
    {# Tab Jurnal Activitate - doar pentru superadmin #}
    {% if user.userprofile and user.userprofile.role and user.userprofile.role.name|lower == 'superadmin' %}
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if request.GET.tab == 'activitylog' %}active{% endif %}" id="activitylog-tab" data-bs-toggle="pill" data-bs-target="#activitylog-pane" type="button" role="tab" aria-controls="activitylog-pane" aria-selected="false">
                <i class="bi bi-list-check admin-icon"></i>Jurnal Activitate
            </button>
        </li>
    {% endif %}
    
    {# Tab Ștergere Documente - doar pentru superadmin #}
    {% if user.userprofile and user.userprofile.role and user.userprofile.role.name|lower == 'superadmin' %}
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if request.GET.tab == 'delete-docs' %}active{% endif %}" id="delete-docs-tab" data-bs-toggle="pill" data-bs-target="#delete-docs-pane" type="button" role="tab" aria-controls="delete-docs-pane" aria-selected="false">
                <i class="bi bi-trash-fill admin-icon"></i>Ștergere Documente
            </button>
        </li>
    {% endif %}
  </ul>

  <div class="tab-content admin-section" id="adminTabsContent">

    {% if user.userprofile and user.userprofile.role and user.userprofile.role.name|lower == 'superadmin' %}

        <div class="tab-pane fade p-1 {% if not request.GET.tab or request.GET.tab == 'user' %}show active{% endif %}" id="user-pane" role="tabpanel" aria-labelledby="user-tab">
            <div class="row g-4">
                <div class="col-lg-5">
                    <div class="card form-card">
                        <div class="card-header"><i class="bi bi-person-plus-fill"></i> Adaugă Utilizator Nou</div>
                        <div class="card-body">
                            <form method="post">
                                {% csrf_token %}
                                {% crispy user_form %}
                                <div class="crispy-form-button-wrapper d-grid">
                                    <button type="submit" name="submit_user" class="btn btn-primary">
                                        <i class="bi bi-check-circle-fill"></i> Creează Utilizator
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-lg-7">
                    <div class="card list-card">
                        <div class="card-header"><i class="bi bi-list-ul"></i> Listă Utilizatori</div>
                        <div class="card-body p-0">
                            {% if users %}
                            <div class="table-responsive">
                                <table class="table table-hover table-admin mb-0">
                                    <thead><tr><th>Username</th><th>Email</th><th>Gestiune</th><th>Rol</th><th class="text-end">Acțiuni</th></tr></thead>
                                    <tbody>
                                    {% for user_obj in users %}
                                    <tr>
                                        <td>{{ user_obj.username }}</td>
                                        <td>{{ user_obj.email|default:"-" }}</td>
                                        <td>{{ user_obj.userprofile.gestiune.nume|default:"-" }}</td>
                                        <td><span class="badge bg-secondary">{{ user_obj.userprofile.role.name|default:"N/A" }}</span></td>
                                        <td class="text-end">
                                            <div class="btn-group">
                                                <a class="btn btn-sm btn-outline-warning" href="{% url 'edit_user_profile' user_obj.id %}" title="Editează Profil/Drepturi"><i class="bi bi-pencil-fill"></i></a>
                                                {% if user_obj.id != request.user.id %}
                                                <form method="post" action="{% url 'delete_user' user_obj.id %}" style="display:inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Sigur dorești să ștergi utilizatorul {{ user_obj.username }}?');" title="Șterge Utilizator"><i class="bi bi-trash-fill"></i></button>
                                                </form>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                                <p class="p-3 text-muted text-center">Nu există utilizatori definiți.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade p-1 {% if request.GET.tab == 'role' %}show active{% endif %}" id="role-pane" role="tabpanel" aria-labelledby="role-tab">
             <div class="row g-4">
                <div class="col-lg-5">
                    <div class="card form-card">
                        <div class="card-header"><i class="bi bi-shield-plus"></i> Adaugă Rol Nou</div>
                        <div class="card-body">
                            <form method="post">
                                {% csrf_token %}
                                {% crispy role_form %}
                                <div class="crispy-form-button-wrapper d-grid">
                                    <button type="submit" name="submit_role" class="btn btn-primary">
                                        <i class="bi bi-check-circle-fill"></i> Creează Rol
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-lg-7">
                    <div class="card list-card">
                        <div class="card-header"><i class="bi bi-list-ul"></i> Listă Roluri</div>
                        <div class="card-body p-0">
                           {% if roles %}
                            <div class="table-responsive">
                                <table class="table table-hover table-admin mb-0">
                                    <thead><tr><th>Nume Rol</th><th class="text-end">Acțiuni</th></tr></thead>
                                    <tbody>
                                    {% for role_obj in roles %}
                                    <tr>
                                        <td>
                                            <i class="bi bi-shield-fill me-2"></i>
                                            <strong>{{ role_obj.get_name_display }}</strong>
                                        </td>
                                        <td class="text-end">
                                            <div class="btn-group">
                                                <a href="{% url 'edit_role' role_obj.id %}" class="btn btn-sm btn-warning" title="Editează Template Permisiuni">
                                                    <i class="bi bi-pencil-fill"></i> Editează Permisiuni
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                           {% else %}
                                <p class="p-3 text-muted text-center">Nu există roluri definite.</p>
                           {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade p-1 {% if request.GET.tab == 'gestiune' %}show active{% endif %}" id="gestiune-pane" role="tabpanel" aria-labelledby="gestiune-tab">
            <div class="row g-4">
                <div class="col-lg-5">
                     <div class="card form-card">
                        <div class="card-header"><i class="bi bi-building-add"></i> Adaugă Gestiune Nouă</div>
                        <div class="card-body">
                            <form method="post">
                                {% csrf_token %}
                                {% crispy gestiune_form %}
                                <div class="crispy-form-button-wrapper d-grid">
                                    <button type="submit" name="submit_gestiune" class="btn btn-primary">
                                        <i class="bi bi-check-circle-fill"></i> Creează Gestiune
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-lg-7">
                     <div class="card list-card">
                        <div class="card-header"><i class="bi bi-list-ul"></i> Listă Gestiuni</div>
                        <div class="card-body p-0">
                            {% if gestiuni %}
                            <div class="table-responsive">
                               <table class="table table-hover table-admin mb-0">
                                    <thead><tr><th>Nume</th><th>Locație</th><th>Cod Reg.</th><th class="text-end">Acțiuni</th></tr></thead>
                                    <tbody>
                                    {% for gest in gestiuni %}
                                    <tr>
                                        <td>{{ gest.nume }}</td>
                                        <td>{{ gest.locatie|default:"-" }}</td>
                                        <td>{{ gest.cod_inregistrare|default:"-" }}</td>
                                        <td class="text-end">
                                            <div class="btn-group">
                                                <a class="btn btn-sm btn-outline-warning" href="{% url 'edit_gestiune' gest.pk %}" title="Editează Gestiune"><i class="bi bi-pencil-fill"></i></a>
                                                <form method="post" action="{% url 'delete_gestiune' gest.pk %}" style="display:inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Sigur dorești să ștergi gestiunea {{ gest.nume }}?');" title="Șterge Gestiune">
                                                        <i class="bi bi-trash-fill"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                                <p class="p-3 text-muted text-center">Nu există gestiuni definite.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade p-1 {% if request.GET.tab == 'documentrange' and user.userprofile and user.userprofile.role.name|lower == 'superadmin' %}show active{% endif %}" id="documentrange-pane" role="tabpanel" aria-labelledby="documentrange-tab">
             <div class="row g-4">
                <div class="col-lg-5">
                     <div class="card form-card">
                        <div class="card-header"><i class="bi bi-plus-slash-minus"></i> Adaugă Plajă Nouă</div>
                        <div class="card-body">
                            <form method="post">
                                {% csrf_token %}
                                {% crispy documentrange_form %}
                                 <div class="crispy-form-button-wrapper d-grid">
                                    <button type="submit" name="submit_documentrange" class="btn btn-primary">
                                        <i class="bi bi-check-circle-fill"></i> Creează Plajă
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-lg-7">
                     <div class="card list-card">
                        <div class="card-header"><i class="bi bi-list-ul"></i> Listă Plaje Numere</div>
                        <div class="card-body p-0">
                             {% if document_ranges %}
                             <div class="table-responsive">
                                <table class="table table-hover table-admin mb-0">
                                    <thead>
                                        <tr>
                                            <th>Gestiune</th>
                                            <th>Tipologie</th>
                                            <th>Început</th>
                                            <th>Final</th>
                                            <th>Curent Utilizat</th>
                                            <th>Următorul de Atribuit</th>
                                            <th class="text-end">Acțiuni</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    {% for range_data in document_ranges %}
                                    <tr>
                                        <td>{{ range_data.gestiune.nume }}</td>
                                        <td>{{ range_data.tipologie.nume }}</td>
                                        <td>{{ range_data.numar_inceput }}</td>
                                        <td>{{ range_data.numar_final }}</td>
                                        <td>{{ range_data.numar_curent|default:"-" }}</td>
                                        <td class="fw-bold">
                                            {% if range_data.urmatorul_numar == "Range epuizat" %}
                                                <span class="badge bg-danger">{{ range_data.urmatorul_numar }}</span>
                                            {% elif range_data.urmatorul_numar == "Format incompatibil" %}
                                                <span class="badge bg-warning text-dark">{{ range_data.urmatorul_numar }}</span>
                                            {% elif range_data.urmatorul_numar %}
                                                {{ range_data.urmatorul_numar }}
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            <div class="btn-group">
                                                <a class="btn btn-sm btn-outline-warning" href="{% url 'edit_document_range' range_data.id %}" title="Editează Plaja"><i class="bi bi-pencil-fill"></i></a>
                                                <form method="post" action="{% url 'delete_document_range' range_data.id %}" style="display:inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Sigur dorești să ștergi această plajă de numere??');" title="Șterge Plaja">
                                                        <i class="bi bi-trash-fill"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                             </div>
                            {% else %}
                                <p class="p-3 text-muted text-center">Nu există plaje de numere definite.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade p-1 {% if request.GET.tab == 'tipologie' %}show active{% endif %}" id="tipologie-pane" role="tabpanel" aria-labelledby="tipologie-tab">
               <div class="row g-4">
                <div class="col-lg-5">
                     <div class="card form-card">
                        <div class="card-header"><i class="bi bi-tag-fill"></i> Adaugă Tipologie Nouă</div>
                        <div class="card-body">
                            <form method="post">
                                {% csrf_token %}
                                {% crispy tipologie_form %}
                                <div class="crispy-form-button-wrapper d-grid">
                                    <button type="submit" name="submit_tipologie" class="btn btn-primary">
                                        <i class="bi bi-check-circle-fill"></i> Creează Tipologie
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-lg-7">
                     <div class="card list-card">
                        <div class="card-header"><i class="bi bi-list-ul"></i> Listă Tipologii</div>
                        <div class="card-body p-0">
                            {% if tipologii %}
                            <div class="table-responsive">
                                <table class="table table-hover table-admin mb-0">
                                    <thead><tr><th>Nume Tipologie</th><th class="text-end">Acțiuni</th></tr></thead>
                                    <tbody>
                                    {% for tip in tipologii %}
                                    <tr>
                                        <td>{{ tip.nume }}</td>
                                        <td class="text-end">
                                             <div class="btn-group">
                                                 <button class="btn btn-sm btn-outline-secondary disabled" title="Editare indisponibilă"><i class="bi bi-pencil-fill"></i></button>
                                                 <form method="post" action="{% url 'delete_tipologie' tip.pk %}" style="display:inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Sigur dorești să ștergi tipologia {{ tip.nume }}?');" title="Șterge Tipologie">
                                                        <i class="bi bi-trash-fill"></i>
                                                    </button>
                                                </form>
                                             </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                           {% else %}
                               <p class="p-3 text-muted text-center">Nu există tipologii definite.</p>
                           {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade p-1 {% if request.GET.tab == 'speciemapping' %}show active{% endif %}" id="speciemapping-pane" role="tabpanel" aria-labelledby="speciemapping-tab">
             <div class="card">
                <div class="card-header"><i class="bi bi-link-45deg"></i> Mapare Specie - Tipologie</div>
                <div class="card-body">
                    <div class="mb-3">
                        <a href="{% url 'update_speciemapping' %}" class="btn btn-success"><i class="bi bi-cloud-arrow-down-fill"></i> Importă/Actualizează Specii Noi</a>
                    </div>
                    <hr>
                    <h5 class="mb-3">Adaugă Mapare Manuală</h5>
                    <form method="post" class="mb-4 border p-3 rounded bg-light">
                        {% csrf_token %}
                        {% crispy speciemapping_form %}
                         <div class="crispy-form-button-wrapper pt-2 border-top-0">
                            <button type="submit" name="submit_speciemapping" class="btn btn-primary">
                                <i class="bi bi-plus-circle-fill"></i> Adaugă Mapare
                            </button>
                         </div>
                    </form>
                    <hr>
                    <h5 class="mb-3">Mapări Existente</h5>
                     {% if speciemapping_list %}
                     <div class="table-responsive">
                        <table class="table table-hover table-admin">
                            <thead><tr><th>Specie</th><th>Tipologie Asignată</th><th class="text-end">Acțiuni</th></tr></thead>
                            <tbody>
                            {% for mapping in speciemapping_list %}
                            <tr>
                                <td>{{ mapping.specie }}</td>
                                <td>{{ mapping.tipologie.nume }}</td>
                                <td class="text-end">
                                    <a href="{% url 'edit_speciemapping' mapping.pk %}" class="btn btn-sm btn-outline-warning" title="Editează Mapare"><i class="bi bi-pencil-fill"></i></a>
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                        <p class="text-muted text-center">Nu există mapări definite.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="tab-pane fade p-1 {% if request.GET.tab == 'seriedata' %}show active{% endif %}" id="seriedata-pane" role="tabpanel" aria-labelledby="seriedata-tab">
             <div class="card">
                <div class="card-header"><i class="bi bi-journal-bookmark-fill"></i> Gestionare Date Extra Serie (LOT)</div>
                <div class="card-body">
                     <p class="text-muted small mb-3">
                        Aici sunt listate datele introduse anterior pentru diferite serii (LOT-uri). Aceste date sunt folosite pentru a
                        pre-popula câmpurile din formularul de generare aviz atunci când o serie cunoscută este detectată.
                        Puteți șterge o intrare dacă nu mai doriți ca datele respective să fie pre-populate automat.
                    </p>
                     <a href="{% url 'list_serie_extra_data' %}" class="btn btn-outline-primary">
                         <i class="bi bi-card-list"></i> Vezi/Șterge Date Serie
                     </a>
                 </div>
             </div>
        </div>

        <div class="tab-pane fade p-1 {% if request.GET.tab == 'usermanual' %}show active{% endif %}" id="usermanual-pane" role="tabpanel" aria-labelledby="usermanual-tab">
            <div class="row">
                <div class="col-lg-5 mb-4 mb-lg-0">
                    <div class="card h-100">
                        <div class="card-header"><i class="bi bi-upload admin-icon"></i>Încarcă Manual Nou</div>
                        <div class="card-body">
                            <a href="{% url 'upload_manual_direct' %}" class="btn btn-success w-100">
                                <i class="bi bi-upload"></i> Încarcă Manual (Pagină dedicată)
                            </a>
                            <div class="mt-4">
                                <p class="text-muted">
                                    <i class="bi bi-info-circle"></i> Pentru a încărca un manual nou, folosiți butonul de mai sus care vă va direcționa către o pagină dedicată acestei funcționalități.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-7">
                    <div class="card h-100">
                        <div class="card-header"><i class="bi bi-list-ul admin-icon"></i>Manuale Încărcate</div>
                        <div class="card-body p-0">
                            {% if manual_list %}
                            <div class="table-responsive">
                                <table class="table table-hover table-admin mb-0">
                                    <thead>
                                        <tr>
                                            <th>Titlu</th>
                                            <th>Versiune</th>
                                            <th>Data Încărcare</th>
                                            <th>Status</th>
                                            <th>Acțiuni</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    {% for manual in manual_list %}
                                    <tr>
                                        <td>{{ manual.title }}</td>
                                        <td>{{ manual.version }}</td>
                                        <td>{{ manual.upload_date|date:"d.m.Y H:i" }}</td>
                                        <td>
                                            <span class="badge {% if manual.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                                {{ manual.is_active|yesno:"Activ,Inactiv" }}
                                            </span>
                                        </td>
                                        <td>
                                        <div class="btn-group">
                                            <a class="btn btn-sm btn-info" href="{% url 'download_manual_specific' manual.id %}" title="Descarcă Manual">
                                                <i class="bi bi-download"></i>
                                            </a>
                                            <form method="post" action="{% url 'delete_manual' manual.id %}" style="display:inline;">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-danger"
                                                       onclick="return confirm('Sigur doriți să ștergeți manualul \'{{ manual.title }}\' (v{{ manual.version }})? Această acțiune este ireversibilă.');"
                                                       title="Șterge Manual">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                    </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                                <p class="p-3 text-muted">Nu există manuale încărcate.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade p-1 {% if request.GET.tab == 'activitylog' %}show active{% endif %}" id="activitylog-pane" role="tabpanel" aria-labelledby="activitylog-tab">
            <div class="card">
                <div class="card-header"><i class="bi bi-list-check"></i> Jurnal Activitate Recentă (Ultimele 100)</div>
                <div class="card-body p-0">
                    {% if activity_logs %}
                    <div class="table-responsive">
                        <table class="table table-sm table-striped table-hover table-admin mb-0">
                            <thead><tr><th style="width: 150px;">Data/Ora</th><th style="width: 120px;">Utilizator</th><th style="width: 150px;">Tip Acțiune</th><th>Detalii</th></tr></thead>
                            <tbody>
                                {% for log in activity_logs %}
                                <tr>
                                    <td><small>{{ log.timestamp|date:"d.m.Y H:i:s" }}</small></td>
                                    <td>{{ log.user.username|default:"<em class='text-muted'>N/A</em>"|safe }}</td>
                                    <td><span class="badge bg-light text-dark border">{{ log.action_type|default:"-" }}</span></td>
                                    <td><small>{{ log.details|linebreaksbr }}</small></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="p-3 text-muted text-center">Nu există înregistrări în jurnalul de activitate.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="tab-pane fade p-1 {% if request.GET.tab == 'delete-docs' %}show active{% endif %}" id="delete-docs-pane" role="tabpanel" aria-labelledby="delete-docs-tab">
            <div class="card">
                <div class="card-header"><i class="bi bi-trash-fill"></i> Ștergere în Masă a Documentelor Generate</div>
                <div class="card-body">
                    <div class="alert alert-danger">
                        <p><i class="bi bi-exclamation-triangle-fill"></i> <strong>ATENȚIE!</strong> Această funcționalitate permite ștergerea definitivă a tuturor documentelor generate.</p>
                        <p>Din motive de securitate, această operațiune necesită confirmări suplimentare.</p>
                    </div>
                    <p>Accesând această funcționalitate veți putea:</p>
                    <ul>
                        <li>Șterge toate documentele generate</li>
                        <li>Șterge documentele generate până la o anumită dată</li>
                    </ul>
                    <div class="mt-4">
                        <a href="{% url 'delete_all_documents' %}" class="btn btn-danger">
                            <i class="bi bi-trash-fill"></i> Accesează Funcția de Ștergere
                        </a>
                    </div>
                </div>
            </div>
        </div>

    {% else %} {# Utilizatorul NU este superadmin #}
        <div class="tab-pane fade show active p-1" id="documentrange-pane" role="tabpanel" aria-labelledby="documentrange-tab">
             <div class="row g-4">
                <div class="col-lg-5">
                     <div class="card form-card">
                        <div class="card-header"><i class="bi bi-plus-slash-minus"></i> Adaugă Plajă Nouă</div>
                        <div class="card-body">
                            <form method="post">
                                {% csrf_token %}
                                {% crispy documentrange_form %}
                                 <div class="crispy-form-button-wrapper d-grid">
                                    <button type="submit" name="submit_documentrange" class="btn btn-primary">
                                        <i class="bi bi-check-circle-fill"></i> Creează Plajă
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-lg-7">
                     <div class="card list-card">
                        <div class="card-header"><i class="bi bi-list-ul"></i> Listă Plaje Numere</div>
                        <div class="card-body p-0">
                             {% if document_ranges %}
                             <div class="table-responsive">
                                <table class="table table-hover table-admin mb-0">
                                    <thead>
                                        <tr>
                                            <th>Gestiune</th>
                                            <th>Tipologie</th>
                                            <th>Început</th>
                                            <th>Final</th>
                                            <th>Curent Utilizat</th>
                                            <th>Următorul de Atribuit</th>
                                            <th class="text-end">Acțiuni</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    {% for range_data in document_ranges %}
                                    <tr>
                                        <td>{{ range_data.gestiune.nume }}</td>
                                        <td>{{ range_data.tipologie.nume }}</td>
                                        <td>{{ range_data.numar_inceput }}</td>
                                        <td>{{ range_data.numar_final }}</td>
                                        <td>{{ range_data.numar_curent|default:"-" }}</td>
                                         <td class="fw-bold">
                                            {% if range_data.urmatorul_numar == "Range epuizat" %}
                                                <span class="badge bg-danger">{{ range_data.urmatorul_numar }}</span>
                                            {% elif range_data.urmatorul_numar == "Format incompatibil" %}
                                                <span class="badge bg-warning text-dark">{{ range_data.urmatorul_numar }}</span>
                                            {% elif range_data.urmatorul_numar %}
                                                {{ range_data.urmatorul_numar }}
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                             <div class="btn-group">
                                                 <a class="btn btn-sm btn-outline-warning" href="{% url 'edit_document_range' range_data.id %}" title="Editează Plaja"><i class="bi bi-pencil-fill"></i></a>
                                                 <form method="post" action="{% url 'delete_document_range' range_data.id %}" style="display:inline;">
                                                     {% csrf_token %}
                                                     <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Sigur dorești să ștergi această plajă de numere?');" title="Șterge Plaja">
                                                         <i class="bi bi-trash-fill"></i>
                                                     </button>
                                                 </form>
                                             </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                             </div>
                            {% else %}
                                <p class="p-3 text-muted text-center">
                                    {% if not user.userprofile.gestiune %}
                                        Nu aveți o gestiune asignată pentru a vedea sau adăuga plaje de numere.
                                    {% else %}
                                        Nu există plaje de numere definite pentru gestiunea ta.
                                    {% endif %}
                                </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    function activateTab(tabId) {
        const tabButton = document.getElementById(tabId + '-tab');
        const tabPane = document.getElementById(tabId + '-pane');

        if (tabButton && tabPane) {
             const activeTabButton = document.querySelector('#adminTabs .nav-link.active');
             const activeTabPane = document.querySelector('#adminTabsContent .tab-pane.active');
             if(activeTabButton) {
                 activeTabButton.classList.remove('active');
                 activeTabButton.setAttribute('aria-selected', 'false');
             }
             if(activeTabPane) {
                 activeTabPane.classList.remove('show', 'active');
             }

            tabButton.classList.add('active');
            tabButton.setAttribute('aria-selected', 'true');
            tabPane.classList.add('show', 'active');
            console.log('Activated tab:', tabId);
        } else {
            console.log('Tab button or pane not found for ID:', tabId);
        }
    }

    const urlParams = new URLSearchParams(window.location.search);
    const tabToActivate = urlParams.get('tab');

    if (tabToActivate) {
        console.log('Found tab parameter in URL:', tabToActivate);
         setTimeout(() => { activateTab(tabToActivate); }, 50); // Redus delay-ul puțin
    } else {
        // Verificăm dacă există deja un tab activ (setat de server sau de o acțiune anterioară)
        const anyActiveTabButton = document.querySelector('#adminTabs .nav-link.active');
        if (!anyActiveTabButton) {
            // Dacă niciun tab nu e activ, activăm primul tab disponibil
            const firstTabButton = document.querySelector('#adminTabs .nav-link');
            if (firstTabButton) {
                console.log('No active tab found or specified, activating first tab:', firstTabButton.id);
                const firstTabId = firstTabButton.id.replace('-tab','');
                activateTab(firstTabId);
            } else {
                console.log('No tabs found on the page.');
            }
        } else {
            console.log('An active tab is already set:', anyActiveTabButton.id);
        }
    }

    // Listener pentru click pe tab-uri pentru a actualiza URL-ul (opțional)
    const tabButtons = document.querySelectorAll('#adminTabs .nav-link');
    tabButtons.forEach(button => {
        button.addEventListener('click', function(event) {
            const tabId = this.id.replace('-tab', '');
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set('tab', tabId);
            // Actualizează URL-ul fără reîncărcare, util pentru bookmarking sau refresh
            window.history.replaceState({}, '', currentUrl);
        });
    });

});
</script>
{% endblock %}